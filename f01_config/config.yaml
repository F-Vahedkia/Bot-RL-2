version: 1.0.0
project:
  name: Bot-RL-2
  timezone: UTC
  base_currency: USD
  random_seed: 42
  enable_env_override: true




extends:
- f01_config/extend_config.yaml   # کمترین اهمیت- کمتر از همین فایل کانفیگ 
# - f01_config/extend_config_2.yaml # اهمیتش از بالایی بیشتر است 
bases:
- f01_config/base_config.yaml     #اهمیت این فایل بیشتراز extendsهااست-اماازهمین فایل کانفیگ(config.yaml) و از overlaysها کمتر است 
# - f01_config/base_config_2.yaml   # اهمیت این فایل از بالایی ها بیشتر است 
overlays:
- f01_config/symbol_specs.yaml    # بیشترین اهمیت- بیش از حتی همین فایل کانفیگ(config.yaml) 
# - f01_config/symbol_specs_22.yaml
# - f01_config/symbol_specs_33.yaml
# ---------------------------------------------------------



paths:
  root_dir: .
  config_versions_dir: f01_config/versions  ####
  
  data_dir:      f02_data
  raw_dir:       f02_data/raw
  processed_dir: f02_data/processed
  news_dir:      f02_data/news
  cache_dir:     f02_data/cache  ####

  models_dir: f12_models  ####
  models:
    production_dir:  f12_models/production
    staging_dir:     f12_models/staging
    checkpoints_dir: f12_models/checkpoints
    experiments_dir: f12_models/experiments
  
  logs_dir:    _logs  ####
  reports_dir: _reports  ####
  tmp_dir:     _tmp   ####




connection:                                                     # Used at: mt5_connector.py
  mt5_credentials:                                              # Used at: mt5_connector.py / _read_credentials_from_config()
    login: 00000000                                             #
    password: Password                                          #
    server: Server                                              #
    terminal_path: "C:/Program Files/Alpari MT5/terminal64.exe" # 

  initialize_retry:                             # Used at: mt5_connector.py / _read_options_from_config()
    max_retries: 2  # int                       #
    retry_delay: 5.0  # float                   #
    backoff_multiplier: 1.0  # float            #
    auto_select_symbols: True  # bool           #
    check_trade_allowed: False  # bool          #
    symbol_activation_timeout: 0.0  # float     #
    ensure_on_each_call: True  # bool           #




features:
  time_features:            ####################
    add_hour_of_day: true      # Used at: data_handler.py / _add_time_features()
    add_day_of_week: true      #
    add_session_flags: true    #
    normalize_time: true       # 

  base_timeframe: M5           # Used at: data_handler.py / class DataHandler / __init__

  representation:
    default: "binary"
    mapping: ""

  pipeline:
    use_default_set: true
    include:
      indicators: true
      price_action: true
      fibonacci: true
      support_resistance: true
      volatility: true
  shift_features_by: 1
  drop_na_head: true
  indicators:
  - div_rsi(14,2,classic)@M1
  - ema(close,20)@M5
  - sar(0.02,0.02,0.2)@M1
  - supertrend(10,3)@M5
  - adx(14)@M30
  - macd(12,26,9)@M1
  - atr(14)@M1
  - bbands(close,20,2)@M1
  - donchian(20)@H1
  - rsi(14)@M1
  - stoch(14,3)@M1
  - vwap@M1
  - cmf(20)@M1
 
  fibonacci:
    enabled: true
    swing_window_bars: 200
    cluster_merge_pips: 20
    order_planner:
      use_atr_for_sl_tp: true
      sl_atr_mult: 1.5
      tp_atr_mult: 2.0
      atr_length: 14
      partial_take_profits:
        enabled: true
        levels_r_multiple:
        - 1.0
        - 2.0
        portions:
        - 0.5
        - 0.5
    retracement_ratios:
    - 0.500
    retracement_ratios_____:
    - 0.236
    - 0.382
    - 0.500
    - 0.618
    - 0.786
    - 0.886
    extension_ratios:
    - 1.272
    - 1.618
    - 2.0
    - 2.618
    - 3.618
    golden_zone:
      ratios:
      - 0.382
      - 0.618
    cluster:
      min_members: 2
      min_score: 5.0
      leg_age_decay: 0.9
    leg_selection:
      max_legs_per_tf: 3
      lookback_bars: 2000
      prefer_body: false
      prominence_min: null
    rsi:
      length: 14
      overbought: 70
      oversold: 30
    tf_overrides:
      M15:
        leg_selection:
          max_legs_per_tf: 5
      H1:
        leg_selection:
          max_legs_per_tf: 4
      H4:
        leg_selection:
          max_legs_per_tf: 3
      D1:
        leg_selection:
          max_legs_per_tf: 2
      W1:
        leg_selection:
          max_legs_per_tf: 1
    symbol_overrides:
      XAUUSD:
        rsi:
          overbought: 72
          oversold: 28
      EURUSD: {}
      GBPUSD: {}
      USDJPY: {}
      USDCHF: {}
      USDCAD: {}
      AUDUSD: {}
      NZDUSD: {}
    harmonics:
      enabled: false
      patterns:
      - AB=CD
      ratio_tolerance: 0.05
    caching:
      enabled: false
      ttl_bars: 500
  support_resistance:
    enabled: true
    lookback_bars: 1500
    cluster_tolerance_pips: 15
    zigzag:         #===== Used by feature_registry.py / zigzag_mtf_adapter() ===== start
      enabled: true
      tf: null            # یعنی: پیش‌فرض = base_timeframe
      depth: 12
      deviation: 5.0
      backstep: 10  #===== Used by feature_registry.py / zigzag_mtf_adapter() ===== end
    sr_advanced:                   # ===== Used by feature_registry.py / _merge_sr_kwargs() ===== start
      common:                      #
        atr_window: 14             #
        max_bars_alive: 5          #
        w_size: 0.5
        w_age: 0.3
        w_touch: 0.2
      fvg:
        lookback: 2
        min_size_pct_of_atr: 0.35
      supply_demand:
        base_len: 3
        base_atr_max: 1.0
        impulse_atr_min: 0.8
      order_block:
        body_atr_min: 0.4
        wick_ratio_max: 1.0
        bos_lookback: 8
      breaker_flip:
        lookback: 20
        ob_body_atr_min: 0.35
        ob_wick_ratio_max: 1.0
        ob_bos_lookback: 10
      liq_sweep:
        lookback: 6
        min_tail_atr: 0.4
      sr_fusion:
        ema_span: 5
        age_norm: 6.0
        enter_th: 0.35
        exit_th: 0.25
        cooldown_bars: 3
        min_conf: 0.25
        tie_eps: 0.02
        confirm_col: null
      overrides:
        XAUUSD:
          H1:
            supply_demand:
              base_atr_max: 1.0
              impulse_atr_min: 0.8 #
            sr_fusion:             #
              enter_th: 0.35       #
              exit_th: 0.25        # ===== Used by feature_registry.py / _merge_sr_kwargs() ===== end
  price_action_params:
    anti_lookahead: true
    market_structure:
      lookback: 3
    regime:
      atr_window: 14
      width_window: 20
      slope_window: 12
      spike_thr_atr: 1.8
      channel_slope_thr: 0.2
    breakouts:
      range_window: 20
      min_periods: 10
      confirm_closes: 1
      retest_lookahead: 5
      fail_break_lookahead: 3
    microchannels:
      min_len: 3
      near_extreme_thr: 0.2
    mtf:
      bias_window_base: 8
      bias_window_higher: 8
      fillna_confluence: 0.5
    confluence:
      weights:
        structure: 0.25
        zones: 0.25
        imbalance: 0.2
        mtf: 0.1
        extras: 0.2
      strong_entry_threshold: 0.7
      filter_threshold: 0.35




env:
  download_defaults:        # 
    symbols:                # Only symbols sed at:
    - XAUUSD                #        mt5_connector.py / _auto_select_symbols()
    - EURUSD                # 
    - GBPUSD                # All of this part used at:
    - USDJPY                #        mt5_data_loader.py / class MT5DataLoader / __init__
    - USDCHF                # 
    - USDCAD                # 
    - AUDUSD                # 
    - NZDUSD                # 
    timeframes:             # 
    - M1                    # 
    - M5                    #
    - M30                   #
    - H4                    #
    - D1                    #
    - W1                    #
    lookback_bars: 20       # در صورتیکه صفر یا منفی باشد، به حساب نمی آید 
    date_from: 2010-01-01 #  در صورتیکه هر دو برابر باشند یا date_from بیشتر باشد به حساب نمی آیند 
    date_to:   now        # مقدار date_to میتواند NOW یا now هم اختیار کند 
    range_policy: date      # میتواند یکی از رشته مقادیر min, max, date, count را داشته باشد 
    batch_size: 50          #
    save_format: parquet    # csv | parquet

    align_to_session: true
    data_raw: f02_data/raw               # در path هم کمی متفاوت آورده شده اند 
    data_processed: f02_data/processed   # در path هم کمی متفاوت آورده شده اند 


  base_tf: M5
  use_ohlc: true
  use_volume: true
  use_spread: false
  reward_mode: pnl
  observation:
    resample_to_base_tf: M5
    clip_values: true
    clip_range:
    - -5
    - 5
  action_space:
    type: discrete
    dim: 3
    read_from_config: true
    #discrete_actions: [STEP_-2, STEP_-1, HOLD, STEP_+1, STEP_+2]  # ۵‌سطح سازگار با نگاشت داخلی
    discrete_actions: [short, hold, long]
    mapping:
      levels: [-1, 0, 1]       # ایندکس اکشن ← تغییر جهت/شدت
      gate_from_flat_requires_extreme: false  # فقط ±2 اجازه ورود مستقیم از حالت فلت
  reward:
    type: risk_adjusted_pnl
    params:
      dd_penalty: 2.5
      trade_cost_penalty: 1.0
  termination:
    max_episode_steps: 5000
    stop_on_margin_call: true
    stop_on_max_drawdown_pct: 0.2
  window_size: 128
  normalize: true
  split:
    ratios:
      train: 0.7
      val: 0.15
      test: 0.15
    fixed:
      train:
      - '2025-08-21'
      - '2025-08-25'
      val:
      - '2025-08-25'
      - '2025-08-26'
      test:
      - '2025-08-26'
      - '2099-12-31'
    align:
      unit: session
      tz: America/New_York
      hhmm: '17:00'
    warmup:
      mode: auto
      margin_bars: 32
    flat_at_boundary: true
  features_whitelist:
  - __rsi_
  - __macd_
  - __ema_close_
  - __atr_
  - __bb_
  - __stoch_
  - __sar_
  - __supertrend_
  features_blacklist:
  - qc_*

  timeframes:
  - M1
  - M5
  - M30
  - H4
  - D1
  - W1
  n_candles_per_tf: 256
  n_candles: 256
  sessions:         ##################
    asia:                   # This part is used in:
      start_utc: 00:00      #     data_handler.py / _add_session_flags ()
      end_utc: 08:00        #
    london:                 #
      start_utc: 08:00      #
      end_utc: '16:00'      #
    newyork:                #
      start_utc: '13:00'    #
      end_utc: '21:00'      #




risk:
  risk_per_trade: 0.01
  max_daily_loss_pct: 0.02
  max_total_drawdown_pct: 0.2
  position_sizing:
    method: fixed_fractional
    min_lot: 0.01
    lot_step: 0.01
    max_lot: 10.0
    use_atr_for_sl: true
    sl_atr_mult: 5.5
    tp_atr_mult: 10.0
    breakeven:
      enabled: true
      at_r_multiple: 1.0
    trailing:
      enabled: true
      type: chandelier
      atr_period: 22
      atr_mult: 3.0
  position_limits:
    max_open_positions: 1
    max_positions_per_symbol: 1
    cooldown_minutes_after_stop: 15
# ---------------------------------------------------------



training:
  total_timesteps: 2000000
  eval_freq_steps: 25000
  checkpoint_interval_steps: 50000
  max_checkpoints_to_keep: 10
  resume_if_exists: true
  early_stop:
    enabled: true
    metric: eval/sharpe
    patience_evals: 8
    min_delta: 0.01
  experiment_name: ppo_baseline_mtf
  rl:
    algorithm: PPO
    policy: MlpPolicy
    hyperparams:
      ppo:
        n_steps: 2048
        batch_size: 256
        gamma: 0.99
        gae_lambda: 0.95
        clip_range: 0.2
        ent_coef: 0.01
        vf_coef: 0.5
        max_grad_norm: 0.5
        learning_rate: 0.0003
        target_kl: 0.01
        n_epochs: 10
        clip_range_vf: 0.2
      sac:
        learning_rate: 0.0003
        buffer_size: 1000000
        batch_size: 256
        gamma: 0.99
        tau: 0.005
        ent_coef: auto
        train_freq: 1
        gradient_steps: 1
        learning_starts: 10000
        target_entropy: auto
      td3:
        learning_rate: 0.0003
        buffer_size: 1000000
        batch_size: 256
        gamma: 0.99
        tau: 0.005
        train_freq: 1
        gradient_steps: 1
        policy_delay: 2
        noise_sigma: 0.1
        noise_clip: 0.3
      a2c:
        n_steps: 5
        gamma: 0.99
        ent_coef: 0.0
        vf_coef: 0.5
        max_grad_norm: 0.5
        learning_rate: 0.0007
      dqn:
        learning_rate: 0.00025
        buffer_size: 100000
        batch_size: 128
        gamma: 0.99
        train_freq: 1
        exploration_fraction: 0.1
        exploration_final_eps: 0.01
        learning_starts: 50000
        target_update_interval: 1000
        tau: 1.0
      ddpg:
        learning_rate: 0.0003
        buffer_size: 1000000
        batch_size: 256
        gamma: 0.99
        tau: 0.005
        train_freq: 1
        gradient_steps: 1
        action_noise: normal(0.1)
        policy_delay: 2



    
evaluation:
  backtest:
    commissions_per_lot_usd: 7.0
    slippage_pips_mean: 2
    slippage_pips_std: 1
    reuse_historical_spread: true
    cross_validation:
      enabled: true
      folds: 3
      method: expanding_window
      min_trades_per_fold: 30
  acceptance_gates:
    sharpe_min: 0.8
    profit_factor_min: 1.2
    winrate_min: 0.48
    max_drawdown_max: 0.12
    turnover_max_per_day: 80
    min_trades_total: 200




executor:
  live_trading: false
  order:
    type: market
    retry_attempts: 3
    timeout_sec: 3.0
    partial_fill_handling: cancel_remaining
  price_point: 0.1
  slippage_cap_pips: 3
  sync_with_env_behaviors: true
  canary_deployment:
    enabled: true
    volume_multiplier: 0.5
    min_duration_minutes: 60
    promote_criteria:
      min_trades: 5
      min_pnl_usd: 0.0
      max_dd_live: 0.03
  rollback:
    on_breach: true
  latency_sla_ms: 2000
  qc:
    stale_seconds: 8
    spike_pips: 25




self_optimize:
  schedule:
    daily_utc: '22:30'
    weekly_utc: Fri 21:00
  steps:
    data_refresh: true
    hparam_search:
      enabled: false
      max_trials: 20
      sampler: tpe
      space:
        pa.market_structure.lookback:
        - 2
        - 3
        - 4
        - 5
        pa.regime.atr_window:
          min: 10
          max: 24
          step: 1
        pa.regime.width_window:
          min: 10
          max: 30
          step: 1
        pa.regime.slope_window:
          min: 6
          max: 20
          step: 1
        pa.regime.spike_thr_atr:
          choices:
          - 1.4
          - 1.6
          - 1.8
          - 2.0
          - 2.2
          - 2.5
        pa.regime.channel_slope_thr:
          min: 0.1
          max: 0.35
          step: 0.05
        pa.breakouts.range_window:
          min: 6
          max: 30
          step: 1
        pa.breakouts.min_periods:
          rule: min_periods = max(3, range_window//3)
        pa.breakouts.confirm_closes:
          choices:
          - 1
          - 2
          - 3
        pa.breakouts.retest_lookahead:
          choices:
          - 3
          - 5
          - 8
        pa.breakouts.fail_break_lookahead:
          choices:
          - 2
          - 3
          - 5
        pa.microchannels.min_len:
          choices:
          - 3
          - 4
          - 5
          - 6
        pa.microchannels.near_extreme_thr:
          choices:
          - 0.1
          - 0.15
          - 0.2
          - 0.25
          - 0.3
        pa.mtf.bias_window_base:
          min: 6
          max: 16
          step: 1
        pa.mtf.bias_window_higher:
          min: 6
          max: 20
          step: 1
        pa.mtf.fillna_confluence:
          choices:
          - 0.3
          - 0.5
        pa.confluence.weights:
          choices:
          - - 0.3
            - 0.3
            - 0.2
            - 0.2
          - - 0.35
            - 0.25
            - 0.2
            - 0.2
          - - 0.25
            - 0.35
            - 0.2
            - 0.2
          - - 0.3
            - 0.25
            - 0.2
            - 0.25
        pa.confluence.strong_entry_threshold:
          min: 0.6
          max: 0.8
          step: 0.02
        pa.confluence.filter_threshold:
          min: 0.3
          max: 0.5
          step: 0.02
    finetune:
      enabled: true
      steps: 75000
      mix_replay_with_recent_pct: 0.2
    backtest:
      enabled: true
    deploy:
      staging_then_promote: true
  acceptance_gates:
    sharpe_min: 0.8
    profit_factor_min: 1.2
    winrate_min: 0.48
    max_drawdown_max: 0.12
    turnover_max_per_day: 80
    min_trades_total: 200
  alerts_on_change: true
# ---------------------------------------------------------



monitoring:
  logging:
    level: INFO
    to_console: true
    to_file: true
    file_path: logs/bot.log
    rotate_max_bytes: 10485760
    rotate_backups: 5
    jsonl: true
  alerts:
    enable_telegram: true
    telegram:
      bot_token_env: TELEGRAM_BOT_TOKEN
      chat_id_env: TELEGRAM_CHAT_ID
    email:
      enabled: false
      smtp_host: ''
      smtp_user_env: SMTP_USER
      smtp_pass_env: SMTP_PASS
      to: []
  reporting:
    daily_summary: true
    weekly_summary: true
    include_equity_curve: true
    include_trade_log: true




safety:
  hard_kill_switch:
    enabled: true
    conditions:
    - name: max_daily_loss
      metric: live/daily_loss_pct
      op: '>='
      value: 0.03
    - name: max_drawdown_total
      metric: live/total_drawdown_pct
      op: '>='
      value: 0.2
    - name: too_many_trades
      metric: live/trades_per_day
      op: '>'
      value: 120
  news_filter:
    enabled: true
    high_impact_freeze_minutes_before: 31
    high_impact_freeze_minutes_after: 16
    medium_impact_freeze_minutes_before: 16
    medium_impact_freeze_minutes_after: 11
    sources:
    - forexfactory
    currencies:
    - USD
    - EUR
    - GBP
    - JPY




cicd:
  enabled: false
  run_unit_tests_on_push: true
  run_backtest_on_main: true
  artifact_retention_days: 30




scripts:
  download_data: scripts/run_download.py
  train: scripts/run_train.py
  backtest: scripts/run_backtest.py
  deploy: scripts/run_deploy.py
  self_optimize: scripts/run_self_optimize.py




secrets:
  use_env: true
  env_keys:
    MT5_LOGIN: MT5_LOGIN
    MT5_PASSWORD: MT5_PASSWORD
    MT5_SERVER: MT5_SERVER
    MT5_PATH: MT5_PATH
    TELEGRAM_BOT_TOKEN: TELEGRAM_BOT_TOKEN
    TELEGRAM_CHAT_ID: TELEGRAM_CHAT_ID




per_symbol_overrides:
  XAUUSD:
    risk:
      risk_per_trade: 0.005
      sl_atr_mult: 5
    evaluation:
      acceptance_gates:
        sharpe_min: 0.9
        max_drawdown_max: 0.1
      backtest:
        #point_value: 10.0